<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>违规违纪记录</title>
    <link rel="icon" href="../../images/icon.jpg">
    <link rel="stylesheet" href="../../layouts/teach_base.css">
    <link rel="stylesheet" href="../../css/teach_vio_records.css">
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://kit.fontawesome.com/52be94c6a3.js" crossorigin="anonymous"></script>
</head>

<body>
    <div class="wrapper">
        <div class="main_container">
            <!-- header Start -->
            <div class="navbar">
                <div class="shousuo">
                    <i class="fa-solid fa-bars"></i>
                </div>
                <div class="page_title">
                    <a href="teach_vio_records.html">违规违纪记录</a>
                </div>
            </div>
            <!-- header END -->
            <div class="content">
                <form>
                <div class="item filter">
                    <div class="select">
                        <div class="above">
                            <div class="selitem">
                                <div class="seltitle">
                                    <span>专业：</span>
                                </div>
                                <div>
                                    <select id="major" class="selcontent">
                                        <option value="">--请选择专业--</option>
                                        <option>工程管理</option>
                                        <option>国际经济与贸易</option>
                                        <option>国际商务</option>
                                        <option>人力资源管理</option>
                                        <option>市场营销</option>
                                        <option>物流管理</option>
                                        <option>信息管理与信息系统</option>
                                        <option>工商管理类</option>
                                        <option>管理科学与工程类</option>
                                        <option>国际经济与贸易（跨境）</option>
                                        <option>国际经济与贸易</option>
                                        <option>国际商务</option>
                                    </select>
                                </div>
                            </div>
                            <div class="selitem">
                                <div class="seltitle">
                                    <span>班级：</span>
                                </div>
                                <div>
                                    <select id="class" class="selcontent">
                                        <option value="">--请选择班级--</option>
                                        <option>1班</option>
                                        <option>2班</option>
                                        <option>3班</option>
                                        <option>4班</option>
                                        <option>5班</option>
                                    </select>
                                </div>
                            </div>
                            <div class="selitem">
                                <div class="seltitle">
                                    <span>原因：</span>
                                </div>
                                <div class="selcontent">
                                    <select id="reason" class="selcontent">
                                        <option value="">--请选择原因--</option>
                                        <option>旷课</option>
                                        <option>迟到</option>
                                        <option>未填问卷</option>
                                    </select>
                                </div>
                            </div>
                            <div class="selitem selitem1">
                                <label for="stu_id">学号：</label>
                                <input type="text" class="selcontent" id="stu_id" name="stu_id" placeholder="请输入学号">
                            </div>
                            <div class="selitem selitem1">
                                <label for="stu_name">姓名：</label>
                                <input type="text" class="selcontent" id="stu_name" name="stu_name" placeholder="请输入姓名">
                            </div>
                            <div class="selitem selitem1">
                                <label for="v_time" id="vio_time">违纪时间：</label>
                                <input type="date" class="selcontent" id="v_time" name="v_time">
                            </div>

                        </div>
                        <div class="below">
                            <div class="operate">
                                <input type="button" value="搜索" class="btn1">
                                <input type="reset" value="重置" class="btn2">
                            </div>
                        </div>    
                    </div>   
                </div>
                </form>
                <div class="item sheet">
                    <table class="table_1">
                        <thead>
                            <tr>
                                <th>序号</th>
                                <th>学号</th>
                                <th>姓名</th>
                                <th>专业</th>
                                <th>班级</th>
                                <th>违纪时间</th>
                                <th>原因</th>
                                <th>扣分分值</th>
                                <th>消除时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="list_content">
                            <tr>
                                <td>1</td>
                                <td>190802101243</td>
                                <td>张三</td>
                                <td>信管专业</td>
                                <td>2班</td>
                                <td>2022-06-01</td>
                                <td>旷课</td>
                                <td>0.2</td>
                                <td>————</td>
                                <td class="t_btn">
                                    <input type="button" value="消除" class="r_btn btn3" data-name="r-1">
                                    <input type="button" value="删除" class="r_btn btn4" data-name="r-2">
                                </td>
                            </tr>

                        </tbody>
                    </table>
                    <div class="page">
                        <div class="page_turn">
                            <span>转到</span>
                            <input name="pageIndex" type="text" value="1" id="pageIndex">
                        </div>
                        <div class="page_amount">
                            <span>共<span id="totalPages">2</span>页</span>
                            <span><span id="totalSize">16</span>条</span>
                        </div>
                        <div class="page_btn">
                            <a href="#" id="pre_page">&lt;</a>
                            <a href="#" id="next_page">&gt;</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 弹窗 -->
            <div class="result-preview">
                <div class="preview" id="pre_clear" data-target="r-1">
                    <p>确认消除？</p>
                    <div class="buttons">
                        <input type="button" value="确认" class="r_operate confirm" id="clear_confirm">
                        <input type="button" value="取消" class="r_operate cancel">
                    </div>
                </div>
                <div class="preview" id="pre_del" data-target="r-2">
                    <p>确认删除该条违纪行为？</p>
                    <div class="buttons">
                        <input type="button" value="确认" class="r_operate confirm"  id="del_confirm">
                        <input type="button" value="取消" class="r_operate cancel">
                    </div>
                </div>
            </div>

        </div>

        

    </div>

    <script src="../../js/base.js"></script>
    <script src="../../js/teach_vio_records.js"></script>
    <script>//学生信息列表
        //页码
        let page = 1;
        let search_flag = 0;
        let major,stu_class,vio_detail,stu_id,stu_name,vio_Time;
        $(".btn1").click(function () {
            if($("#major").val() == "" && $("#class").val() == ""&& $("#reason").val() == "" && $("#stu_id").val() == "" && $("#stu_name").val() == ""&& $("#v_time").val() == ""){
                page = 1;
                search_flag = 0;
                showListContent(page);
            }else {
                page = 1;
                search_flag = 1;
                major = $("#major").val();
                stu_class = $("#class").val();
                vio_detail = $("#reason").val();
                stu_id = $("#stu_id").val();
                stu_name = $("#stu_name").val();
                vio_Time = $("#v_time").val();
                showSearchContent(1, major,stu_class,vio_detail,stu_id,stu_name,vio_Time);
            }
        })

        //左右切换页面
        $("#pre_page").click(function () {
            if (page <= 1){
                alert("此页为第一页");
            }else {
                page = page - 1;
                if (search_flag == 0){
                    showListContent(page);
                }else{
                    showSearchContent(page,major,stu_class,vio_detail,stu_id,stu_name,vio_Time);
                }
            }
        })
        $("#next_page").click(function () {
            if (page == $("#totalPages").text()){
                alert("此页为最后一页");
            }else {
                page++;
                if (search_flag == 0){
                    showListContent(page);
                }else{
                    showSearchContent(page,major,stu_class,vio_detail,stu_id,stu_name,vio_Time);
                }
            }
        })

        //输入页码跳转
        $("#pageIndex").keydown(function (event) {
            if (event.keyCode == 13){
                if (parseInt($("#pageIndex").val()) >= 1 && parseInt($("#pageIndex").val()) <= parseInt($("#totalPages").text())){
                    page = $("#pageIndex").val();
                    if (search_flag == 0){
                        showListContent(page);
                    }else{
                        showSearchContent(page,major,stu_class,vio_detail,stu_id,stu_name,vio_Time);
                    }
                }else {
                    alert("请输入1 ~ " + $("#totalPages").text() + "的页码");
                }

            }
        })

        $(document).ready(function () {
            showListContent(page);
        });

        function showListContent(page) {
            $("#list_content").empty();//清空tbody标签中的数据
            //辅导员获取学生基本信息列表
            $.ajax({
                url: "/violation/list/menter",
                type: "GET",
                data: "pageNum=" + page + "&pageSize=8",
                dataType: "JSON",
                success: function (json) {
                    let list = json.data.content;
                    //console.log(list.length);
                    $("#totalSize").html(json.data.totalSize)
                    $("#totalPages").html(json.data.totalPages)
                    $("#pageIndex").val(page)
                    for (let i = 0; i < list.length; i++) {
                        //alert(list[i].stu_Name);
                        let tr = '<tr>\n' +
                            '<td>#{number}</td>\n' +
                            '<td>#{stu_Id}</td>\n' +
                            '<td>#{stu_Name}</td>\n' +
                            '<td>#{major}</td>\n' +
                            '<td>#{stu_class}</td>\n' +
                            '<td>#{vio_Time}</td>\n' +
                            '<td>#{vio_detail}</td>\n' +
                            '<td>#{vio_Score}</td>\n' +
                            '<td>#{cancel_Time}</td>\n' +
                            '<td class="t_btn">' +
                            '<input type="button" value="消除" class="r_btn btn3" data-name="r-1" onclick="btnclear(#{vio_Id})">\n' +
                            '<input type="button" value="删除" class="r_btn btn4" data-name="r-2" onclick="btndel(#{vio_Id})">\n' +
                            '</td>' +
                            '</tr>';

                        tr = tr.replace(/#{stu_Id}/g, list[i].stu_Id);
                        tr = tr.replace(/#{stu_Name}/g, list[i].stu_Name);
                        tr = tr.replace(/#{major}/g, list[i].major);
                        tr = tr.replace(/#{stu_class}/g, list[i].stu_class);
                        tr = tr.replace(/#{vio_Time}/g, list[i].vio_Time);
                        tr = tr.replace(/#{vio_detail}/g, list[i].vio_detail);
                        tr = tr.replace(/#{vio_Score}/g, list[i].vio_Score);
                        tr = tr.replace(/#{cancel_Time}/g, list[i].cancel_Time);
                        tr = tr.replace(/#{vio_Id}/g, list[i].vio_Id.replace("v",""));

                        tr = tr.replace(/#{number}/g, i + 1 + (page - 1) * 8);

                        $("#list_content").append(tr);
                    }
                },
                error: function (xhr) {
                    alert("数据加载产生未知异常," + xhr.msg)
                }
            });
        }
        function showSearchContent(page,major,stu_class,vio_detail,stu_id,stu_name,vio_Time){
            $("#list_content").empty();//清空tbody标签中的数据
            //辅导员查询获取学生基本信息列表
            $.ajax({
                url: "/violation/list/query",
                type: "GET",
                data: "pageNum=" + page + "&pageSize=8" + "&major=" + major + "&stu_class="
                    + stu_class + "&vio_detail=" + vio_detail + "&stu_Id=" + stu_id + "&stu_Name=" + stu_name
                    + "&vio_Time=" + vio_Time,
                dataType: "JSON",
                success: function (json) {
                    if (json.code == 200) {
                        let list = json.data.content;
                        //console.log(list.length);
                        $("#totalSize").html(json.data.totalSize)
                        $("#totalPages").html(json.data.totalPages)
                        $("#pageIndex").val(page)
                        for(let i = 0 ; i < list.length ; i++){
                            //alert(list[i].stu_Name);
                            let tr = '<tr>\n' +
                                '<td>#{number}</td>\n' +
                                '<td>#{stu_Id}</td>\n' +
                                '<td>#{stu_Name}</td>\n' +
                                '<td>#{major}</td>\n' +
                                '<td>#{stu_class}</td>\n' +
                                '<td>#{vio_Time}</td>\n' +
                                '<td>#{vio_detail}</td>\n' +
                                '<td>#{vio_Score}</td>\n' +
                                '<td>#{cancel_Time}</td>\n' +
                                '<td class="t_btn">' +
                                '<input type="button" value="消除" class="r_btn btn3" data-name="r-1" onclick="btnclear(#{vio_Id})">\n'+
                                '<input type="button" value="删除" class="r_btn btn4" data-name="r-2" onclick="btndel(#{vio_Id})">\n' +
                                '</td>' +
                                '</tr>';
                                tr = tr.replace(/#{stu_Id}/g, list[i].stu_Id);
                                tr = tr.replace(/#{stu_Name}/g, list[i].stu_Name);
                                tr = tr.replace(/#{major}/g, list[i].major);
                                tr = tr.replace(/#{stu_class}/g, list[i].stu_class);
                                tr = tr.replace(/#{vio_Time}/g, list[i].vio_Time);
                                tr = tr.replace(/#{vio_detail}/g, list[i].vio_detail);
                                tr = tr.replace(/#{vio_Score}/g, list[i].vio_Score);
                                tr = tr.replace(/#{cancel_Time}/g, list[i].cancel_Time);
                                tr = tr.replace(/#{vio_Id}/g, list[i].vio_Id.replace("v",""));

                                tr = tr.replace(/#{number}/g , i + 1 + (page - 1) * 8);
                                $("#list_content").append(tr);
                                }
                            } else {
                                alert('查无数据');
                            }
                        },
                    error: function (xhr) {
                        alert("查找时产生未知异常：" + xhr.msg);
                    }
                });
        }
    </script>
    <script>
        function btnclear(vio_Id){
            $(".result-preview").css("display","flex");
            $("#pre_clear").addClass("active");
            $("#clear_confirm").click(function(){
                $(".preview").each(function(){
                    $("#pre_clear").removeClass("active");
                    $("#pre_del").removeClass("active");
                });
                $(".result-preview").css("display","none");

                $.ajax({
                    url: "/violation/" + vio_Id + "/cancel",
                    type: "PUT",
                    dataType : "JSON",
                    success : function (json) {
                        if (json.code == 200){
                            alert('成功');
                            window.location.reload();
                        }
                        else{
                            alert('失败');
                            window.location.reload();
                        }
                    },
                    error : function (xhr) {
                        alert("产生未知异常," + xhr.detailMessage)
                    }
                });
                vio_Id = 0;
            });

        }

        function btndel(vio_Id){
            $(".result-preview").css("display","flex");
            $("#pre_del").addClass("active");
            $("#del_confirm").click(function(){
                $(".preview").each(function(){
                    $("#pre_clear").removeClass("active");
                    $("#pre_del").removeClass("active");
                });
                $(".result-preview").css("display","none");

                $.ajax({
                    url: "/violation/" + vio_Id + "/delete",
                    type: "DELETE",
                    dataType : "JSON",
                    success : function (json) {
                        if (json.code == 200){
                            alert('成功');
                            window.location.reload();
                        }
                        else{
                            alert('失败');
                            window.location.reload();
                        }
                    },
                    error : function (xhr) {
                        alert("产生未知异常," + xhr.detailMessage)
                    }
                });
                vio_Id = 0;
            });
        }
    </script>
</body>

</html>