<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>总评成绩管理</title>
    <link rel="icon" href="../../images/icon.jpg">
    <link rel="stylesheet" href="../../layouts/admin_base.css">
    <link rel="stylesheet" href="../../css/admin_export.css">
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://kit.fontawesome.com/52be94c6a3.js" crossorigin="anonymous"></script>
</head>

<body>
    <div class="wrapper">
        
        <div class="main_container">
            <!-- header Start -->
            <div class="navbar">
                <div class="shousuo">
                    <i class="fa-solid fa-bars"></i>
                </div>
                <div class="page_title">
                    <a href="admin_export.html">总评成绩管理</a>
                </div>
            </div>
            <!-- header END -->
            <div class="content">
                <form>
                <div class="item filter">
                    <div class="select">
                        <div class="above">
                            <div class="selitem">
                                <div class="seltitle">
                                    <span>年级：</span>
                                </div>
                                <div>
                                    <select id="grade" class="selcontent">
                                        <option value="0">--请选择年级--</option>
                                        <option>2022</option>
                                        <option>2021</option>
                                        <option>2020</option>
                                        <option>2019</option>
                                        <option>2018</option>
                                        <option>2017</option>
                                        <option>2016</option>
                                    </select>
                                </div>
                            </div>
                            <div class="selitem">
                                <div class="seltitle">
                                    <span>专业：</span>
                                </div>
                                <div class="selcontent">
                                    <select id="major" class="selcontent">
                                        <option value="">--请选择专业--</option>
                                        <option>工程管理</option>
                                        <option>国际经济与贸易</option>
                                        <option>国际商务</option>
                                        <option>人力资源管理</option>
                                        <option>市场营销</option>
                                        <option>物流管理</option>
                                        <option>信息管理与信息系统</option>
                                        <option>工商管理类</option>
                                        <option>管理科学与工程类</option>
                                        <option>国际经济与贸易（跨境）</option>
                                        <option>国际经济与贸易</option>
                                        <option>国际商务</option>
                                    </select>
                                </div>
                            </div>
                            <div class="selitem">
                                <div class="seltitle">
                                    <span>班级：</span>
                                </div>
                                <div>
                                    <select id="class_name" class="selcontent">
                                        <option value="">--请选择班级--</option>
                                        <option>1班</option>
                                        <option>2班</option>
                                        <option>3班</option>
                                        <option>4班</option>
                                        <option>5班</option>
                                    </select>
                                </div>
                            </div>
<!--                            <div id="under">-->
                                <div class="selitem selitem1">
                                    <label for="apply">学号：</label>
                                    <input type="text" id="stu_id" class="selcontent" name="stu_id" placeholder="请输入学号" minlength="12" maxlength="12">
                                </div>
                                <div class="selitem selitem1">
                                    <label for="stu_id">姓名：</label>
                                    <input type="text" id="stu_name" class="selcontent" name="stu_name" placeholder="请输入姓名">
                                </div>
                                <div class="selitem">
                                    <div class="seltitle">
                                        <span>学期：</span>
                                    </div>
                                    <div>
                                        <select id="semester" class="selcontent">
                                            <option value="">--请选择学期--</option>
                                            <option value="2022-2023-1">2022-2023-1</option>
                                            <option value="2021-2022-2">2021-2022-2</option>
                                            <option value="2021-2022-1">2021-2022-1</option>
                                            <option value="2020-2021-2">2020-2021-2</option>
                                            <option value="2020-2021-1">2020-2021-1</option>
                                            <option value="2019-2020-2">2019-2020-2</option>
                                            <option value="2019-2020-2">2019-2020-1</option>
                                        </select>
                                    </div>    
                                </div>
<!--                            </div>   -->
                        </div>
                        <div class="below">
                            <div class="operate">
                                <input type="button" value="搜索" class="btn1">
                                <input type="reset" value="重置" class="btn2">
                            </div>
                        </div>    
                    </div>   
                </div>
                </form>
                <div class="item sheet">
                    <button class="export" id="export">导出成绩</button>
                    <table class="table_1">
                        <thead>
                            <tr>
                                <th>学号</th>
                                <th>姓名</th>
                                <th>未得学分</th>
                                <th>绩点</th>
                                <th>德育加分</th>
                                <th>竞赛加分</th>
                                <th>创新加分</th>
                                <th>公益加分</th>
                                <th>其他加分</th>
                                <th>违纪扣分</th>
                                <th>总分</th>
                                <th>排名</th>
                                <th>学期</th>
                            </tr>
                        </thead>
                        <tbody id="list_content">
                            <tr>
                                <td>190802101243</td>
                                <td>xxx</td>
                                <td>0</td>
                                <td>3.5</td>
                                <td>1</td>
                                <td>2</td>
                                <td>2</td>
                                <td>1</td>
                                <td>1</td>
                                <td>0</td>
                                <td>1</td>
                                <td>0</td>
                                <td>0</td>
                                <td>10</td>
                                <td>10</td>
                                <td>2022-2023-1</td>
                            </tr>
                            <tr>
                                <td>190802101243</td>
                                <td>xxx</td>
                                <td>0</td>
                                <td>3.5</td>
                                <td>1</td>
                                <td>2</td>
                                <td>2</td>
                                <td>1</td>
                                <td>1</td>
                                <td>0</td>
                                <td>1</td>
                                <td>0</td>
                                <td>0</td>
                                <td>10</td>
                                <td>10</td>
                                <td>2022-2023-1</td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="page">
                        <div class="page_turn">
                            <span>转到</span>
                            <input name="pageIndex" type="text" value="1" id="pageIndex">
                        </div>
                        <div class="page_amount">
                            <span>共<span id="totalPages">2</span>页</span>
                            <span><span id="totalSize">16</span>条</span>
                        </div>
                        <div class="page_btn">
                            <a href="#" id="pre_page">&lt;</a>
                            <a href="#" id="next_page">&gt;</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="../../js/base.js"></script>
<!--    <script src="../../js/stu_id_check.js"></script>-->

    <script>
        //页码
        let page = 1;
        let search_flag = 0;
        let grade,major,class_name,stu_id,stu_name,semester;
        $(".btn1").click(function () {
            if($("#grade").val() == 0 && $("#major").val() == "" && $("#class_name").val() == ""
                && $("#stu_id").val() == "" && $("#stu_name").val() == "" && $("#semester").val() == ""){
                page = 1;
                search_flag = 0;
                showListContent(page);
            }else {
                page = 1;
                search_flag = 1;
                grade = $("#grade").val();
                major = $("#major").val();
                class_name = $("#class_name").val();
                stu_id = $("#stu_id").val();
                stu_name = $("#stu_name").val();
                semester = $("#semester").val();
                showSearchContent(1,grade,major,class_name,stu_id,stu_name,semester);
            }
        })

        //左右切换页面
        $("#pre_page").click(function () {
            if (page <= 1){
                alert("此页为第一页");
            }else {
                page = page - 1;
                if (search_flag == 0){
                    showListContent(page);
                }else{
                    showSearchContent(page,grade,major,class_name,stu_id,stu_name,semester);
                }
            }
        })
        $("#next_page").click(function () {
            if (page == $("#totalPages").text()){
                alert("此页为最后一页");
            }else {
                page++;
                if (search_flag == 0){
                    showListContent(page);
                }else{
                    showSearchContent(page,grade,major,class_name,stu_id,stu_name,semester);
                }
            }
        })

        //输入页码跳转
        $("#pageIndex").keydown(function (event) {
            if (event.keyCode == 13){
                if (parseInt($("#pageIndex").val()) >= 1 && parseInt($("#pageIndex").val()) <= parseInt($("#totalPages").text())){
                    page = $("#pageIndex").val();
                    if (search_flag == 0){
                        showListContent(page);
                    }else{
                        showSearchContent(page,grade,major,class_name,stu_id,stu_name,semester);
                    }
                }else {
                    alert("请输入1 ~ " + $("#totalPages").text() + "的页码");
                }

            }
        })

        $(document).ready(function () {
            showListContent(page);
        });

        function showListContent(page) {
            $("#list_content").empty();
            $.ajax({
                url : "/admin/total-score",
                type : "GET",
                data : "pageNum=" + page + "&pageSize=8",
                dataType : "JSON",
                success : function (json) {
                    let list = json.data.content;
                    $("#totalSize").html(json.data.totalSize)
                    $("#totalPages").html(json.data.totalPages)
                    $("#pageIndex").val(page)
                    for(let i = 0 ; i < list.length ; i++){
                        //alert(list[i].stu_Name);
                        let tr = '<tr>\n' +
                            '<td id="stu_Id#{stu_Id}">#{stu_Id}</td>\n' +
                            '<td id="stu_Name#{stu_Name}">#{stu_Name}</td>\n' +
                            '<td id="ungetcredit#{ungetcredit}">#{ungetcredit}</td>\n' +
                            '<td id="total_GPA#{total_GPA}">#{total_GPA}</td>\n' +
                            '<td id="total_moral#{total_moral}">#{total_moral}</td>\n' +
                            '<td id="total_competition#{total_competition}">#{total_competition}</td>\n' +
                            '<td id="total_innovate#{total_innovate}">#{total_innovate}</td>\n' +
                            '<td id="publicwelfare#{publicwelfare}">#{publicwelfare}</td>\n' +
                            '<td id="total_elsepoint#{total_elsepoint}">#{total_elsepoint}</td>\n' +
                            '<td id="total_violate#{total_violate}">#{total_violate}</td>\n' +
                            '<td id="total_score#{total_score}">#{total_score}</td>\n' +
                            '<td id="ranking#{ranking}">#{ranking}</td>\n' +
                            '<td id="semester#{semester}">#{semester}</td>\n' +
                        '</tr>';
                        tr = tr.replace(/#{stu_Id}/g , list[i].stu_Id);
                        tr = tr.replace(/#{stu_Name}/g , list[i].stu_Name);
                        tr = tr.replace(/#{ungetcredit}/g , list[i].ungetcredit);
                        tr = tr.replace(/#{total_GPA}/g , list[i].total_GPA);
                        tr = tr.replace(/#{total_moral}/g , list[i].total_moral);
                        tr = tr.replace(/#{total_competition}/g , list[i].total_competition);
                        tr = tr.replace(/#{total_innovate}/g , list[i].total_innovate);
                        tr = tr.replace(/#{publicwelfare}/g , list[i].total_publicwelfare);
                        tr = tr.replace(/#{total_elsepoint}/g , list[i].total_elsepoint);
                        tr = tr.replace(/#{total_violate}/g , list[i].total_violate);
                        tr = tr.replace(/#{total_score}/g , list[i].total_score);
                        tr = tr.replace(/#{ranking}/g , list[i].ranking);
                        tr = tr.replace(/#{semester}/g , list[i].semester);
                        $("#list_content").append(tr);
                    }
                },
                error : function (xhr) {
                    alert("数据加载产生未知异常," + xhr.msg)
                }
            });

        }


        function showSearchContent(page,grade,major,class_name,stu_id,stu_name,semester){
            $("#list_content").empty();
            $.ajax({
                url: "/admin/total-score/query",
                type: "GET",
                data: "pageNum=" + page + "&pageSize=8" + "&grade=" + grade + "&major=" + major + "&stu_class="
                    + class_name + "&stu_Id=" + stu_id + "&stu_Name=" + stu_name + "&semester=" + semester,
                dataType: "JSON",
                success : function (json) {
                    let list = json.data.content;
                    $("#totalSize").html(json.data.totalSize)
                    $("#totalPages").html(json.data.totalPages)
                    $("#pageIndex").val(page)
                    for(let i = 0 ; i < list.length ; i++){
                        //alert(list[i].stu_Name);
                        let tr = '<tr>\n' +
                            '<td id="stu_Id#{stu_Id}">#{stu_Id}</td>\n' +
                            '<td id="stu_Name#{stu_Name}">#{stu_Name}</td>\n' +
                            '<td id="ungetcredit#{ungetcredit}">#{ungetcredit}</td>\n' +
                            '<td id="total_GPA#{total_GPA}">#{total_GPA}</td>\n' +
                            '<td id="total_moral#{total_moral}">#{total_moral}</td>\n' +
                            '<td id="total_competition#{total_competition}">#{total_competition}</td>\n' +
                            '<td id="total_innovate#{total_innovate}">#{total_innovate}</td>\n' +
                            '<td id="publicwelfare#{publicwelfare}">#{publicwelfare}</td>\n' +
                            '<td id="total_elsepoint#{total_elsepoint}">#{total_elsepoint}</td>\n' +
                            '<td id="total_violate#{total_violate}">#{total_violate}</td>\n' +
                            '<td id="total_score#{total_score}">#{total_score}</td>\n' +
                            '<td id="ranking#{ranking}">#{ranking}</td>\n' +
                            '<td id="semester#{semester}">#{semester}</td>\n' +
                        '</tr>';
                        tr = tr.replace(/#{stu_Id}/g , list[i].stu_Id);
                        tr = tr.replace(/#{stu_Name}/g , list[i].stu_Name);
                        tr = tr.replace(/#{ungetcredit}/g , list[i].ungetcredit);
                        tr = tr.replace(/#{total_GPA}/g , list[i].total_GPA);
                        tr = tr.replace(/#{total_moral}/g , list[i].total_moral);
                        tr = tr.replace(/#{total_competition}/g , list[i].total_competition);
                        tr = tr.replace(/#{total_innovate}/g , list[i].total_innovate);
                        tr = tr.replace(/#{publicwelfare}/g , list[i].total_publicwelfare);
                        tr = tr.replace(/#{total_elsepoint}/g , list[i].total_elsepoint);
                        tr = tr.replace(/#{total_violate}/g , list[i].total_violate);
                        tr = tr.replace(/#{total_score}/g , list[i].total_score);
                        tr = tr.replace(/#{ranking}/g , list[i].ranking);
                        tr = tr.replace(/#{semester}/g , list[i].semester);
                        $("#list_content").append(tr);
                    }
                },
                error : function (xhr) {
                    alert("数据加载产生未知异常," + xhr.msg)
                }
            });
        }

    </script>

    <script>
        $("#export").click(function() {
            //要导出的json数据
            var jsonData = [{}]

            $.ajax({
                url: "/admin/total-score",
                type: "GET",
                data: "pageNum=1&pageSize=9999",
                dataType: "JSON",
                async: false,
                success : function (json) {
                    let list = json.data.content;
                    for(let i = 0 ; i < list.length ; i++){

                        var data = "#{stu_Id},#{stu_Name},#{ungetcredit},#{total_GPA},#{total_moral},#{total_competition},#{total_innovate},#{publicwelfare},#{total_elsepoint},#{total_violate},#{total_score},#{ranking},#{semester}"
                        data = data.replace(/#{stu_Id}/g ,list[i].stu_Id);
                        data = data.replace(/#{stu_Name}/g , list[i].stu_Name);
                        data = data.replace(/#{ungetcredit}/g , list[i].ungetcredit);
                        data = data.replace(/#{total_GPA}/g , list[i].total_GPA);
                        data = data.replace(/#{total_moral}/g , list[i].total_moral);
                        data = data.replace(/#{total_competition}/g , list[i].total_competition);
                        data = data.replace(/#{total_innovate}/g , list[i].total_innovate);
                        data = data.replace(/#{publicwelfare}/g , list[i].total_publicwelfare);
                        data = data.replace(/#{total_elsepoint}/g , list[i].total_elsepoint);
                        data = data.replace(/#{total_violate}/g , list[i].total_violate);
                        data = data.replace(/#{total_score}/g , list[i].total_score);
                        data = data.replace(/#{ranking}/g , list[i].ranking);
                        data = data.replace(/#{semester}/g , list[i].semester);

                        jsonData.push([data]);
                    }
                },
                error : function (xhr) {
                    alert("数据加载产生未知异常," + xhr.msg)
                }
            });


            //列标题，逗号隔开，每一个逗号就是隔开一个单元格
            let str = '学号,姓名,未得学分,绩点,德育加分,竞赛加分,创新加分,公益加分,其他加分,违纪扣分,总分,排名,学期\n';
            //增加\t为了不让表格显示科学计数法或者其他格式
            for (let i = 0; i < jsonData.length; i++) {
                for (let item in jsonData[i]) {
                    str += `${jsonData[i][item] + '\t'},`;
                }
                str += '\n';
            }
            //encodeURIComponent解决中文乱码
            let uri = 'data:text/csv;charset=utf-8,\ufeff' + encodeURIComponent(str);
            //通过创建a标签实现
            var link = document.createElement("a");
            link.href = uri;
            //对下载的文件命名
            link.download = "综测成绩数据.xls";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

        });
    </script>

</body>

</html>